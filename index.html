<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RealDiary ‚Äî Priyanshu & Ria (Ultimate Upgraded)</title>
  <meta name="description" content="Ultra-realistic diary: page-curl physics, unlimited pages, pressure-sensitive handwriting, multiple brushes, Hindi UI, custom cover art, save PNG & library ‚Äî single-file." />
  <style>
    /* Reset */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body,#app{height:100%}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;background:#05050a;color:#f1f5f9;overflow:hidden}

    /* Background */
    .bg{position:fixed;inset:0;z-index:0;background:radial-gradient(ellipse at 10% 10%, rgba(255,255,255,0.02) 0%, transparent 25%),linear-gradient(180deg,#040409,#0a0a10)}
    canvas.stars{position:fixed;inset:0;pointer-events:none;z-index:0}

    /* Enter Glass */
    .enter-wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:120}
    .glass{width:min(920px,94%);padding:36px;border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));backdrop-filter:blur(10px) saturate(120%);border:1px solid rgba(255,255,255,0.05);box-shadow:0 30px 100px rgba(0,0,0,0.75);display:flex;gap:18px;align-items:center}
    .glass h1{font-size:26px;margin-bottom:6px}
    .enter-btn{padding:14px 28px;border-radius:12px;border:none;cursor:pointer;font-weight:800;background:linear-gradient(90deg,#ffd86b,#ff6060);color:#111}

    /* App topbar */
    .topbar{height:64px;display:flex;align-items:center;padding:0 18px;gap:12px;z-index:100;position:relative}
    .mark{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#ffd86b,#ff6060);display:flex;align-items:center;justify-content:center;color:#111;font-weight:800}
    .top-actions{margin-left:auto;display:flex;gap:8px}
    .btn{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:inherit;cursor:pointer}

    /* Layout */
    .main{display:flex;height:calc(100% - 64px);z-index:100}
    .sidebar{width:320px;border-right:1px solid rgba(255,255,255,0.03);padding:18px;overflow:auto;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .content{flex:1;display:flex;align-items:center;justify-content:center;padding:20px;position:relative}

    /* Library */
    .lib-grid{display:grid;grid-template-columns:1fr;gap:10px}
    .card{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02)}
    .thumb{width:72px;height:56px;border-radius:6px;background:#f8f5ef;overflow:hidden}

    /* Book */
    .book-wrap{width:min(1100px,94%);height:min(820px,88%);position:relative;perspective:2600px}
    .book{position:relative;width:920px;height:720px;margin:auto;transform-style:preserve-3d}

    /* Cover */
    .cover{position:absolute;left:0;top:0;width:50%;height:100%;transform-origin:left center;border-radius:12px;box-shadow:0 50px 140px rgba(2,6,10,0.75);display:flex;align-items:center;padding:28px;background:linear-gradient(180deg,#3b0f52,#16071b);color:white;z-index:140}
    .cover .title-large{font-size:22px;font-weight:800}
    .cover .names{margin-top:12px;opacity:0.9}
    .spine{position:absolute;right:-28px;top:8%;width:28px;height:84%;background:linear-gradient(180deg,#4b154d,#120517);border-radius:4px}

    /* Pages stack */
    .pages{position:absolute;left:50%;top:0;width:50%;height:100%;transform-style:preserve-3d;pointer-events:auto}
    .page{position:absolute;left:0;top:0;width:100%;height:100%;border-radius:10px;background:#fff;box-shadow:0 26px 60px rgba(2,6,10,0.6);overflow:hidden;transform-origin:left center}
    .paper{position:absolute;inset:14px;border-radius:6px;padding:18px 22px 60px 22px;overflow:auto;background-repeat:repeat;box-shadow:inset 0 1px 0 rgba(255,255,255,0.6)}

    /* realistic paper texture via SVG data URI */
    .paper{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400"><filter id="n"><feTurbulence baseFrequency="0.9" numOctaves="2" seed="9"/><feColorMatrix type="saturate" values="0"/><feComponentTransfer><feFuncA type="table" tableValues="0 0.55"/></feComponentTransfer></filter><rect width="100%" height="100%" fill="%23fbf7ef"/><rect width="100%" height="100%" filter="url(%23n)" opacity="0.035"/></svg>');background-size:260px 260px}

    /* editor */
    .title{font-weight:700;margin-bottom:6px;color:#111}
    .editor{width:100%;height:100%;outline:none;font-size:18px;line-height:1.6;color:#111;background:transparent}

    /* handwriting canvas overlay */
    .draw-canvas{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none}

    /* controls */
    .page-controls{position:absolute;right:12px;bottom:12px;display:flex;gap:8px}

    /* toolbar for brushes */
    .brushbar{display:flex;gap:8px;align-items:center;margin-top:12px}
    .swatch{width:34px;height:34px;border-radius:6px;border:1px solid rgba(0,0,0,0.2);cursor:pointer}

    /* index overlay */
    .index-overlay{position:fixed;inset:0;background:linear-gradient(180deg, rgba(2,6,10,0.6), rgba(2,6,10,0.85));display:none;align-items:center;justify-content:center;z-index:200}
    .index-panel{width:min(1100px,96%);height:min(820px,92%);background:#06060a;border-radius:12px;padding:16px;overflow:auto}

    @media(max-width:1000px){.sidebar{display:none}.book-wrap{width:92%;height:78%}}
  </style>
</head>
<body>
  <div class="bg"></div>
  <canvas id="stars" class="stars"></canvas>

  <!-- ENTER -->
  <div class="enter-wrap" id="enterWrap">
    <div class="glass" role="dialog">
      <div style="flex:1">
        <h1>Open RealDiary ‚Äî Ultimate</h1>
        <p style="opacity:0.9">Now with page-curl physics, pressure-sensitive handwriting, smoothing, multiple brushes, Hindi UI, and custom cover ‚Äî all single-file and offline.</p>
        <p style="opacity:0.7;margin-top:8px">Instructions: Tap cover to open. Click right edge or "Turn" to curl a page. Use pointer/finger to draw. Ctrl/Cmd+S saves the visible page.</p>
      </div>
      <div style="display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center">
        <button class="enter-btn" id="enterBtn">ENTER</button>
        <button class="btn" id="openSample">Open Sample</button>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none;position:relative;z-index:150">
    <div class="topbar">
      <div style="display:flex;align-items:center;gap:12px"><div class="mark">RD</div><div><strong id="brandTitle">RealDiary</strong><div id="smallTag" style="font-size:12px;opacity:0.7">Priyanshu ‚Ä¢ Ria</div></div></div>
      <div class="top-actions">
        <div class="tools">
          <button class="btn" id="openIndexBtn">üìö Index</button>
          <button class="btn" id="newPageBtn">‚ûï New Page</button>
          <button class="btn" id="undoDrawBtn">‚Ü∫ Undo</button>
          <button class="btn" id="clearDrawBtn">üßº Clear Draw</button>
          <button class="btn" id="downloadAllBtn">‚¨áÔ∏è Export All</button>
        </div>
      </div>
    </div>

    <div class="main">
      <aside class="sidebar">
        <h3>Library</h3>
        <div id="libraryList" class="lib-grid"></div>

        <hr style="margin:12px 0;border-color:rgba(255,255,255,0.02)">
        <div><strong>Brushes</strong></div>
        <div class="brushbar" id="brushbar">
          <div class="swatch" data-brush="pen" title="Pen" style="background:#0b0b0b;color:#fff;display:flex;align-items:center;justify-content:center">Pen</div>
          <div class="swatch" data-brush="pencil" title="Pencil" style="background:linear-gradient(180deg,#e6e2d8,#cfc9b8);">Pencil</div>
          <div class="swatch" data-brush="marker" title="Marker" style="background:linear-gradient(180deg,#ffd86b,#ff6060);">Marker</div>
          <div style="margin-left:auto;display:flex;gap:6px;align-items:center"><input type="color" id="brushColor" value="#111111" style="width:46px;height:34px;border-radius:6px;border:none"><input type="range" id="brushSize" min="1" max="18" value="3"></div>
        </div>

        <hr style="margin:12px 0;border-color:rgba(255,255,255,0.02)">
        <div><strong>Language</strong></div>
        <div style="display:flex;gap:8px;margin-top:8px"><button class="btn" id="langEN">English</button><button class="btn" id="langHI">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</button></div>

        <hr style="margin:12px 0;border-color:rgba(255,255,255,0.02)">
        <div><strong>Cover</strong></div>
        <div style="margin-top:8px"><input id="coverTitle" placeholder="Custom title" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit"></div>
        <div style="margin-top:8px"><input id="coverNames" placeholder="Names (e.g. Priyanshu & Ria)" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit"></div>
        <div style="margin-top:8px"><textarea id="coverPoem" rows="3" placeholder="A short poem to print on cover" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit"></textarea></div>
        <div style="margin-top:8px"><button class="btn" id="applyCover">Apply Cover</button></div>

      </aside>

      <section class="content">
        <div class="book-wrap">
          <div class="book" id="book">
            <div class="cover" id="cover">
              <div>
                <div class="title-large" id="coverTitleDisplay">My RealDiary</div>
                <div class="names" id="coverNamesDisplay">Priyanshu ‚Ä¢ Ria</div>
                <div style="margin-top:12px;opacity:0.9;font-size:13px" id="coverPoemDisplay">A place for memories & notes</div>
              </div>
              <div class="spine"></div>
            </div>

            <div class="pages" id="pages"></div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- INDEX OVERLAY -->
  <div class="index-overlay" id="indexOverlay">
    <div class="index-panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <h2 style="margin:0">Library</h2>
        <div><button class="btn" id="closeIndex">Close</button></div>
      </div>
      <div id="indexGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px"></div>
    </div>
  </div>

  <a id="downloadAnchor" style="display:none"></a>

  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
  /* ==================================================
     Ultimate Upgraded RealDiary ‚Äî single-file
     Features added now:
     - Page curl (canvas-based approximation)
     - Pressure-sensitive, smoothed handwriting with multiple brushes
     - Hindi UI toggle
     - Custom cover art (title, names, poem)
     - Unlimited pages simulation, zero-critical glitches (best-effort)
     ================================================== */

  // Simple helpers
  const $ = s => document.querySelector(s);
  const uid = (p='p')=>p+Math.random().toString(36).slice(2,9);

  // Starfield
  (function(){const c=$('#stars');const ctx=c.getContext('2d');function r(){c.width=innerWidth;c.height=innerHeight}addEventListener('resize',r);r();const stars=[];for(let i=0;i<320;i++)stars.push({x:Math.random()*c.width,y:Math.random()*c.height,r:Math.random()*1.6,alpha:Math.random()});function draw(){ctx.clearRect(0,0,c.width,c.height);for(const s of stars){ctx.globalAlpha=s.alpha;ctx.beginPath();ctx.fillStyle='#fff';ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill()}}setInterval(()=>{for(const s of stars){s.alpha=0.3+Math.random()*0.8;s.x+=Math.random()*1-0.4;if(s.x>c.width)s.x=0;if(s.x<0)s.x=c.width}},700); (function loop(){draw();requestAnimationFrame(loop)})();})();

  // State & storage
  const LS_KEY='realdiary_v3';
  const state={pages:[], currentTopId:null, uiLang:'en', brush:{type:'pen', color:'#111111', size:3}};
  function load(){try{const raw=localStorage.getItem(LS_KEY);state.pages=raw?JSON.parse(raw):[]; }catch(e){state.pages=[]}}
  function save(){localStorage.setItem(LS_KEY, JSON.stringify(state.pages)); renderLibrary(); renderIndexGrid();}

  // Page model
  function newPage(title='Untitled'){return {id:uid(),title,content:'',drawings:[],created:Date.now()}}

  // Render library
  function renderLibrary(){const list=$('#libraryList');list.innerHTML='';if(!state.pages.length){list.innerHTML='<div style="opacity:0.7">No saved pages yet</div>';return}state.pages.slice().reverse().forEach(p=>{const card=document.createElement('div');card.className='card';card.innerHTML=`<div class='thumb' data-id='${p.id}'></div><div style='flex:1'><strong>${escapeHtml(p.title)}</strong><div style='font-size:12px;opacity:0.7'>${new Date(p.created).toLocaleString()}</div></div><div style='display:flex;flex-direction:column;gap:6px'><button class='btn' data-open='${p.id}'>Open</button><button class='btn' data-png='${p.id}'>PNG</button></div>`;list.appendChild(card);const thumb=card.querySelector('.thumb');thumb.style.background='#f8f5ef';thumb.style.display='flex';thumb.style.alignItems='center';thumb.style.justifyContent='center';thumb.textContent=(p.title||'Untitled').slice(0,12)})}
  function renderIndexGrid(){const g=$('#indexGrid');g.innerHTML='';state.pages.slice().reverse().forEach(p=>{const el=document.createElement('div');el.style.padding='12px';el.style.borderRadius='8px';el.style.background='linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))';el.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${escapeHtml(p.title)}</strong><div style="font-size:12px;opacity:0.7">${new Date(p.created).toLocaleString()}</div></div><div style="display:flex;flex-direction:column;gap:6px"><button class='btn' data-open='${p.id}'>Open</button><button class='btn' data-download='${p.id}'>PNG</button></div></div>`;g.appendChild(el)})}

  function escapeHtml(s=''){return String(s||'').replace(/[&<>\"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'})[c])}

  // Pages DOM
  const pagesRoot = $('#pages');
  function clearPages(){pagesRoot.innerHTML=''}

  // Create page element with editor and drawing canvas
  function createPageElement(pageData,stackIndex=0){
    const el=document.createElement('div'); el.className='page'; el.dataset.id=pageData.id; el.style.zIndex=200-stackIndex; el.style.transform = `translateZ(${stackIndex*-6}px)`;

    const paper=document.createElement('div'); paper.className='paper';
    const title=document.createElement('div'); title.className='title'; title.textContent=pageData.title; title.contentEditable=true; title.style.cursor='text'; title.style.userSelect='text'; title.style.marginBottom='8px'; title.style.color='#111';
    const editor=document.createElement('div'); editor.className='editor'; editor.contentEditable=true; editor.spellcheck=false; editor.innerHTML=pageData.content||'';

    const controls=document.createElement('div'); controls.className='page-controls';
    const saveBtn=document.createElement('button'); saveBtn.className='btn'; saveBtn.textContent='üíæ Save';
    const pngBtn=document.createElement('button'); pngBtn.className='btn'; pngBtn.textContent='üì∑ Save PNG';
    const turnBtn=document.createElement('button'); turnBtn.className='btn'; turnBtn.textContent='‚§µÔ∏è Turn';
    controls.appendChild(saveBtn); controls.appendChild(pngBtn); controls.appendChild(turnBtn);

    paper.appendChild(title); paper.appendChild(editor); paper.appendChild(controls);
    el.appendChild(paper);

    // drawing canvas overlay (absolute inside page coordinate)
    const drawCanvas = document.createElement('canvas'); drawCanvas.className='draw-canvas'; drawCanvas.width=800; drawCanvas.height=600; drawCanvas.style.position='absolute'; drawCanvas.style.left='14px'; drawCanvas.style.top='14px'; drawCanvas.style.width='calc(100% - 28px)'; drawCanvas.style.height='calc(100% - 28px)'; drawCanvas.style.pointerEvents='none'; el.appendChild(drawCanvas);

    // set up resize for canvas to match paper area
    function fit(){ const r=paper.getBoundingClientRect(); drawCanvas.width=Math.max(400,Math.round(r.width)); drawCanvas.height=Math.max(300,Math.round(r.height)); drawCanvas.style.left=r.left+'px'; drawCanvas.style.top=r.top+'px'; drawCanvas.style.width=r.width+'px'; drawCanvas.style.height=r.height+'px'; }
    setTimeout(()=>{fit(); window.addEventListener('resize', fit)},50);

    // restore drawings
    setTimeout(()=>{restoreDrawingsToCanvas(el,pageData.drawings||[])},120);

    // click handlers for turn
    turnBtn.addEventListener('click', (ev)=>{ev.stopPropagation(); pageCurlAnimation(el)});
    el.addEventListener('click',(ev)=>{const r=el.getBoundingClientRect(); const x=ev.clientX - r.left; if(x > r.width*0.78) pageCurlAnimation(el)});

    // save handler
    saveBtn.addEventListener('click',(ev)=>{ev.stopPropagation(); const content = editor.innerHTML; const titleText = title.textContent||'Untitled'; const idx = state.pages.findIndex(p=>p.id===pageData.id); if(idx>=0){ state.pages[idx].content = content; state.pages[idx].title = titleText; state.pages[idx].drawings = captureDrawings(el); save(); alert((state.uiLang==='hi')?'‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ':'Saved.'); } else { state.pages.push({id:pageData.id,title:titleText,content:content,drawings:captureDrawings(el),created:Date.now()}); save(); alert((state.uiLang==='hi')?'‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ':'Saved to Library.'); } });

    // png handler
    pngBtn.addEventListener('click',(ev)=>{ev.stopPropagation(); exportPagePNG(el, pageData.title||'page')});

    // enable drawing interactions
    enableDrawingOnPage(el);

    return el;
  }

  // Render top N pages
  function renderPages(){ clearPages(); const last = state.pages.slice(-10); if(!last.length){ const tmp=newPage('Blank'); tmp.id='temp'; const el=createPageElement(tmp,0); pagesRoot.appendChild(el); state.currentTopId=tmp.id; return } last.forEach((p,i)=>{ const el=createPageElement(p,i); pagesRoot.appendChild(el); }); }

  // Page curl animation (canvas-based warp approximation)
  function pageCurlAnimation(pageEl){ // capture page area to image, animate a curl canvas on top
    const paper = pageEl.querySelector('.paper'); html2canvas(paper, {scale:2, backgroundColor:'#fff'}).then(base=>{
      // overlay canvas
      const overlay = document.createElement('canvas'); overlay.style.position='fixed'; overlay.style.left=paper.getBoundingClientRect().left+'px'; overlay.style.top=paper.getBoundingClientRect().top+'px'; overlay.width=base.width; overlay.height=base.height; overlay.style.width=paper.clientWidth+'px'; overlay.style.height=paper.clientHeight+'px'; overlay.style.zIndex=9999; document.body.appendChild(overlay);
      const ctx = overlay.getContext('2d');
      // animation params
      const frames = 40; let t=0;
      function drawFrame(){ ctx.clearRect(0,0,overlay.width,overlay.height);
        // draw base
        ctx.save(); ctx.globalCompositeOperation='source-over'; ctx.drawImage(base,0,0);
        // simulated curl: draw a clipped gradient on right side and rotate a folded piece
        const w=overlay.width, h=overlay.height;
        // fold width grows
        const fold = Math.sin((t/frames)*Math.PI) * (w*0.45);
        // draw shadow on main
        const grad = ctx.createLinearGradient(w-fold,0,w,0); grad.addColorStop(0,'rgba(0,0,0,0)'); grad.addColorStop(1,'rgba(0,0,0,0.35)'); ctx.fillStyle=grad; ctx.fillRect(w-fold,0,fold,h);
        // draw curled piece as transformed image (simple shear/scale)
        ctx.save(); const sx = 1 - (fold/(w*1.2)); const shear = fold/(w*0.6);
        ctx.translate(w - fold*0.5, 0);
        ctx.transform(sx, 0, shear*0.0005, 1, 0, 0);
        ctx.globalAlpha = 0.98;
        ctx.drawImage(base, -fold, 0);
        ctx.restore();

        // top glossy
        const gloss = ctx.createLinearGradient(w-fold,0,w-fold+fold*0.6,0);
        gloss.addColorStop(0,'rgba(255,255,255,0.06)'); gloss.addColorStop(1,'rgba(255,255,255,0)'); ctx.fillStyle=gloss; ctx.fillRect(w-fold,0,fold*0.6,h);

        t++; if(t<=frames){requestAnimationFrame(drawFrame)} else { // finish
            overlay.remove(); // simulate page removed & add a fresh new page to end
            const p=newPage('Page '+(state.pages.length+1)); state.pages.push(p); save(); renderPages(); }
      }
      drawFrame();
    }).catch(e=>{console.error(e); alert('Curl failed: '+e.message)});
  }

  // Drawing infrastructure: smoothing & pressure
  const drawStore = {ctxMap:new Map(),undoMap:new Map(),currentStroke:[],config:{type:'pen',color:'#111',size:3}};

  function enableDrawingOnPage(pageEl){ const canvas = pageEl.querySelector('.draw-canvas'); if(!canvas) return; // ensure size
    const paper = pageEl.querySelector('.paper'); const pr=paper.getBoundingClientRect(); canvas.width = Math.max(400, Math.round(pr.width)); canvas.height = Math.max(300, Math.round(pr.height)); canvas.style.left=pr.left+'px'; canvas.style.top=pr.top+'px'; canvas.style.width=pr.width+'px'; canvas.style.height=pr.height+'px'; canvas.style.pointerEvents='auto'; const ctx=canvas.getContext('2d'); ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle = state.brush.color; ctx.lineWidth = state.brush.size; drawStore.ctxMap.set(pageEl.dataset.id,ctx); drawStore.undoMap.set(pageEl.dataset.id,[]);

    let drawing=false; let last=null; let smoothingBuffer=[];
    function getXY(e){ const r=canvas.getBoundingClientRect(); const x=(e.clientX - r.left)*(canvas.width/r.width); const y=(e.clientY - r.top)*(canvas.height/r.height); const pressure = e.pressure===undefined? (e.force || 0.5) : e.pressure; return {x,y,pressure}; }

    function start(e){ e.preventDefault(); drawing=true; smoothingBuffer=[]; last=getXY(e); smoothingBuffer.push(last); ctx.beginPath(); ctx.moveTo(last.x,last.y); }
    function move(e){ if(!drawing) return; const p=getXY(e); smoothingBuffer.push(p); // smoothing: take average of last few
      const smooth = averagePoints(smoothingBuffer,4); const width = computeWidth(smooth.pressure); ctx.lineWidth = width; ctx.strokeStyle = state.brush.color; ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(smooth.x,smooth.y); ctx.stroke(); last = smooth; // limit buffer
      if(smoothingBuffer.length>6) smoothingBuffer.shift(); }
    function end(e){ if(!drawing) return; drawing=false; // push snapshot for undo
      const id = pageEl.dataset.id; const data = canvas.toDataURL(); const stack = drawStore.undoMap.get(id) || []; stack.push(data); drawStore.undoMap.set(id, stack); }

    canvas.addEventListener('pointerdown', start); window.addEventListener('pointermove', move); window.addEventListener('pointerup', end);
  }

  function averagePoints(buf,n){ const sample = buf.slice(-n); if(!sample.length) return buf[buf.length-1]; let x=0,y=0,p=0; for(const s of sample){x+=s.x;y+=s.y;p+=s.pressure} return {x:x/sample.length,y:y/sample.length,pressure:p/sample.length}; }
  function computeWidth(pressure){ const base = state.brush.size; if(state.brush.type==='pencil') return Math.max(1, base * (0.6 + pressure*0.8)); if(state.brush.type==='marker') return Math.max(2, base * (1.6 + pressure)); return Math.max(1, base * (0.8 + pressure)); }

  function restoreDrawingsToCanvas(pageEl, drawings){ const canvas = pageEl.querySelector('.draw-canvas'); if(!canvas) return; const ctx=canvas.getContext('2d'); canvas.width = Math.max(400,Math.round(pageEl.querySelector('.paper').clientWidth)); canvas.height = Math.max(300,Math.round(pageEl.querySelector('.paper').clientHeight)); ctx.clearRect(0,0,canvas.width,canvas.height); drawings.forEach(d=>{ const img=new Image(); img.onload=()=>{ ctx.drawImage(img,0,0,canvas.width,canvas.height) }; img.src=d }); enableDrawingOnPage(pageEl); }
  function captureDrawings(pageEl){ const canvas = pageEl.querySelector('.draw-canvas'); if(!canvas) return []; try{ return [canvas.toDataURL()]; }catch(e){return []} }

  function undoDrawOnVisible(){ const top = pagesRoot.lastElementChild; if(!top) return; const id = top.dataset.id; const stack = drawStore.undoMap.get(id) || []; if(stack.length>1){ stack.pop(); const prev = stack[stack.length-1]; const canvas = top.querySelector('.draw-canvas'); const ctx=canvas.getContext('2d'); const img=new Image(); img.onload=()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,canvas.width,canvas.height)}; img.src=prev; drawStore.undoMap.set(id,stack);} else { const canvas = top.querySelector('.draw-canvas'); const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height); drawStore.undoMap.set(id,[]); }}
  function clearDrawOnVisible(){ const top = pagesRoot.lastElementChild; if(!top) return; const canvas = top.querySelector('.draw-canvas'); const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height); drawStore.undoMap.set(top.dataset.id,[]); }

  // Export functions
  function exportPagePNG(pageEl, title='page'){ const paper = pageEl.querySelector('.paper'); html2canvas(paper, {scale:2, backgroundColor:'#fff'}).then(baseCanvas=>{ const draw = pageEl.querySelector('.draw-canvas'); const tmp = document.createElement('canvas'); tmp.width = baseCanvas.width; tmp.height = baseCanvas.height; const tctx = tmp.getContext('2d'); tctx.drawImage(baseCanvas,0,0); if(draw){ const dimg = new Image(); dimg.onload = ()=>{ tctx.drawImage(dimg,0,0,tmp.width,tmp.height); tmp.toBlob(blob=>{ const url=URL.createObjectURL(blob); const a=$('#downloadAnchor'); a.href=url; a.download=(title.replace(/[^a-z0-9]/gi,'_')||'page')+'.png'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),2000); }); }; dimg.src = draw.toDataURL(); } else { tmp.toBlob(blob=>{ const url=URL.createObjectURL(blob); const a=$('#downloadAnchor'); a.href=url; a.download=(title.replace(/[^a-z0-9]/gi,'_')||'page')+'.png'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),2000); }); } }).catch(e=>{console.error(e); alert('Export failed')}); }

  function downloadPagePNGFromData(pageData){ const tmp = document.createElement('div'); tmp.style.width='800px'; tmp.style.height='600px'; tmp.style.padding='24px'; tmp.style.background='#fff'; tmp.style.color='#111'; tmp.innerHTML=`<h2>${escapeHtml(pageData.title)}</h2><div>${pageData.content}</div>`; document.body.appendChild(tmp); html2canvas(tmp, {scale:2}).then(c=>{ c.toBlob(blob=>{ const url=URL.createObjectURL(blob); const a=$('#downloadAnchor'); a.href=url; a.download=(pageData.title.replace(/[^a-z0-9]/gi,'_')||'page')+'.png'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),2000); tmp.remove(); })}).catch(e=>{tmp.remove();alert('Export error')}) }

  // UI wiring
  $('#enterBtn').addEventListener('click', ()=>{ $('#enterWrap').style.display='none'; $('#app').style.display='block'; load(); renderLibrary(); renderPages(); });
  $('#openSample').addEventListener('click', ()=>{ load(); if(state.pages.length===0){ state.pages.push({id:uid(),title:'Memories',content:'<p>This is your first saved page. Write here.</p>',drawings:[],created:Date.now()}); state.pages.push({id:uid(),title:'Dreams',content:'<p>Second page.</p>',drawings:[],created:Date.now()}); save(); } $('#enterWrap').style.display='none'; $('#app').style.display='block'; renderLibrary(); renderPages(); });

  $('#newPageBtn').addEventListener('click', ()=>{ const p=newPage('Page '+(state.pages.length+1)); state.pages.push(p); save(); renderPages(); });
  $('#downloadAllBtn').addEventListener('click', ()=>{ const data=JSON.stringify(state.pages,null,2); const blob=new Blob([data],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=$('#downloadAnchor'); a.href=url; a.download='realdiary-backup.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),2000); });

  $('#openIndexBtn').addEventListener('click', ()=>{ renderIndexGrid(); $('#indexOverlay').style.display='flex'; });
  $('#closeIndex').addEventListener('click', ()=>{ $('#indexOverlay').style.display='none' });

  // index and library actions
  $('#indexOverlay').addEventListener('click',(e)=>{ const openId = e.target.closest('[data-open]')?.dataset.open; const downloadId = e.target.closest('[data-download]')?.dataset.download; if(openId){ openSaved(openId); $('#indexOverlay').style.display='none' } if(downloadId){ const p=state.pages.find(x=>x.id===downloadId); if(p) downloadPagePNGFromData(p) } });
  $('#libraryList').addEventListener('click',(e)=>{ const id=e.target.closest('[data-open]')?.dataset.open; const png=e.target.closest('[data-png]')?.dataset.png; if(id) openSaved(id); if(png){ const p=state.pages.find(x=>x.id===png); if(p) downloadPagePNGFromData(p) } });

  function openSaved(id){ const p=state.pages.find(x=>x.id===id); if(!p) return alert('Not found'); clearPages(); const el=createPageElement(p,0); pagesRoot.appendChild(el); }

  // brush toolbar
  document.getElementById('brushbar').addEventListener('click',(e)=>{ const b = e.target.closest('[data-brush]'); if(b){ state.brush.type = b.dataset.brush; updateBrushUI(); } });
  $('#brushColor').addEventListener('input',(e)=>{ state.brush.color = e.target.value; updateBrushUI(); });
  $('#brushSize').addEventListener('input',(e)=>{ state.brush.size = parseInt(e.target.value,10); updateBrushUI(); });
  function updateBrushUI(){ // update drawStore config and existing visible canvas
    drawStore.config = {...drawStore.config, type:state.brush.type, color:state.brush.color, size:state.brush.size}; const canv = pagesRoot.querySelectorAll('.draw-canvas'); canv.forEach(c=>{ const ctx=c.getContext('2d'); ctx.strokeStyle = state.brush.color; ctx.lineWidth = state.brush.size; }); }

  // language toggle
  $('#langEN').addEventListener('click', ()=>{ state.uiLang='en'; localize('en'); });
  $('#langHI').addEventListener('click', ()=>{ state.uiLang='hi'; localize('hi'); });
  function localize(lang){ if(lang==='hi'){ $('#brandTitle').textContent='‡§∞‡•Ä‡§Ø‡§≤‡§°‡§æ‡§Ø‡§∞‡•Ä'; $('#smallTag').textContent='‡§™‡•ç‡§∞‡§ø‡§Ø‡§Ç‡§∂‡•Å ‚Ä¢ ‡§∞‡§ø‡§Ø‡§æ'; $('#enterBtn').textContent='‡§™‡•ç‡§∞‡§µ‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç'; $('#openSample').textContent='‡§®‡§Æ‡•Ç‡§®‡§æ ‡§ñ‡•ã‡§≤‡•á‡§Ç' } else { $('#brandTitle').textContent='RealDiary'; $('#smallTag').textContent='Priyanshu ‚Ä¢ Ria'; $('#enterBtn').textContent='ENTER'; $('#openSample').textContent='Open Sample' } }

  // cover apply
  $('#applyCover').addEventListener('click', ()=>{ const t=$('#coverTitle').value.trim(); const n=$('#coverNames').value.trim(); const p=$('#coverPoem').value.trim(); if(t) $('#coverTitleDisplay').textContent=t; if(n) $('#coverNamesDisplay').textContent=n; if(p) $('#coverPoemDisplay').textContent=p; alert('Cover updated') });

  // undo/clear
  $('#undoDrawBtn').addEventListener('click', ()=>{ undoDrawOnVisible(); });
  $('#clearDrawBtn').addEventListener('click', ()=>{ clearDrawOnVisible(); });

  // keyboard save
  window.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='s'){ e.preventDefault(); const top=pagesRoot.lastElementChild; if(!top) return; const title=top.querySelector('.title').textContent||'Untitled'; const content=top.querySelector('.editor').innerHTML; const idx=state.pages.findIndex(p=>p.id===top.dataset.id); if(idx>=0){ state.pages[idx].title=title; state.pages[idx].content=content; state.pages[idx].drawings=captureDrawings(top); save(); alert((state.uiLang==='hi')?'‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ':'Saved'); } else { state.pages.push({id:top.dataset.id,title,content,drawings:captureDrawings(top),created:Date.now()}); save(); alert((state.uiLang==='hi')?'‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ':'Saved to Library.'); } } });

  // save before unload
  window.addEventListener('beforeunload', ()=>{ save(); });

  // init
  (function init(){ load(); renderLibrary(); renderIndexGrid(); localize(state.uiLang); })();

  // MutationObserver to attach drawing on new pages
  const mo = new MutationObserver(()=>{ const pageEls = pagesRoot.querySelectorAll('.page'); pageEls.forEach(pe=>{ if(!drawStore.ctxMap.has(pe.dataset.id)) restoreDrawingsToCanvas(pe, (state.pages.find(x=>x.id===pe.dataset.id)||{}).drawings||[]) }) }); mo.observe(pagesRoot,{childList:true,subtree:true});

  </script>
</body>
</html>
