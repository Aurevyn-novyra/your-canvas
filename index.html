<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RealDiary ‚Äî Priyanshu & Ria (Upgraded)</title>
  <meta name="description" content="Ultra-realistic diary: unlimited pages, realistic page turn, handwriting brush, save to PNG, and library ‚Äî single-file." />
  <style>
    /* Reset */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body,#app{height:100%}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;background:#06060a;color:#f1f5f9;overflow:hidden}

    /* Background */
    .bg{position:fixed;inset:0;z-index:0;background:radial-gradient(ellipse at 10% 10%, rgba(255,255,255,0.02) 0%, transparent 25%),linear-gradient(180deg,#05050a,#0b0b11)}
    .stars{position:fixed;inset:0;pointer-events:none;z-index:0}

    /* Enter Glass */
    .enter-wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:20}
    .glass{width:min(820px,92%);padding:36px;border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));backdrop-filter:blur(8px) saturate(120%);border:1px solid rgba(255,255,255,0.05);box-shadow:0 20px 80px rgba(0,0,0,0.7);display:flex;gap:18px;align-items:center}
    .glass h1{font-size:26px;margin-bottom:6px}
    .enter-btn{padding:14px 26px;border-radius:12px;border:none;cursor:pointer;font-weight:800;background:linear-gradient(90deg,#ffd86b,#ff6060);color:#111}

    /* App topbar */
    .topbar{height:64px;display:flex;align-items:center;padding:0 18px;gap:12px;z-index:10;position:relative}
    .mark{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#ffd86b,#ff6060);display:flex;align-items:center;justify-content:center;color:#111;font-weight:800}
    .top-actions{margin-left:auto;display:flex;gap:8px}
    .btn{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:inherit;cursor:pointer}

    /* Layout */
    .main{display:flex;height:calc(100% - 64px);z-index:10}
    .sidebar{width:320px;border-right:1px solid rgba(255,255,255,0.03);padding:18px;overflow:auto;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .content{flex:1;display:flex;align-items:center;justify-content:center;padding:20px;position:relative}

    /* Library */
    .lib-grid{display:grid;grid-template-columns:1fr;gap:10px}
    .card{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02)}
    .thumb{width:72px;height:56px;border-radius:6px;background:#f6f2eb;overflow:hidden}

    /* Book */
    .book-wrap{width:min(980px,92%);height:min(720px,86%);position:relative;perspective:2200px}
    .book{position:relative;width:840px;height:640px;margin:auto;transform-style:preserve-3d}

    /* Cover */
    .cover{position:absolute;left:0;top:0;width:50%;height:100%;transform-origin:left center;border-radius:12px;box-shadow:0 40px 120px rgba(2,6,10,0.7);display:flex;align-items:center;padding:28px;background:linear-gradient(180deg,#2b0e3a,#1a0720);color:white;z-index:40}
    .spine{position:absolute;right:-28px;top:8%;width:28px;height:84%;background:linear-gradient(180deg,#3a123c,#120517);border-radius:4px}

    /* Pages stack */
    .pages{position:absolute;left:50%;top:0;width:50%;height:100%;transform-style:preserve-3d;pointer-events:auto}
    .page{position:absolute;left:0;top:0;width:100%;height:100%;border-radius:10px;background:#fff;box-shadow:0 18px 40px rgba(2,6,10,0.6);overflow:hidden;transform-origin:left center}
    .paper{position:absolute;inset:14px;border-radius:6px;padding:22px;overflow:auto;background-repeat:repeat;box-shadow:inset 0 1px 0 rgba(255,255,255,0.6)}

    /* realistic paper texture via SVG data URI */
    .paper{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400"><filter id="n"><feTurbulence baseFrequency="0.8" numOctaves="2" seed="2"/><feColorMatrix type="saturate" values="0"/><feComponentTransfer><feFuncA type="table" tableValues="0 0.6"/></feComponentTransfer></filter><rect width="100%" height="100%" fill="%23f8f4ee"/><rect width="100%" height="100%" filter="url(%23n)" opacity="0.03"/></svg>');background-size:240px 240px}

    /* editor */
    .title{font-weight:700;margin-bottom:6px;color:#111}
    .editor{width:100%;height:100%;outline:none;font-size:18px;line-height:1.6;color:#111;background:transparent}

    /* handwriting canvas overlay */
    .draw-canvas{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none}

    /* controls */
    .page-controls{position:absolute;right:12px;bottom:12px;display:flex;gap:8px}

    /* index overlay */
    .index-overlay{position:fixed;inset:0;background:linear-gradient(180deg, rgba(2,6,10,0.6), rgba(2,6,10,0.85));display:none;align-items:center;justify-content:center;z-index:80}
    .index-panel{width:min(1000px,96%);height:min(760px,92%);background:#06060a;border-radius:12px;padding:16px;overflow:auto}

    /* toolbars */
    .tools{display:flex;gap:8px;align-items:center}
    .color-swatch{width:32px;height:32px;border-radius:6px;border:1px solid rgba(0,0,0,0.2);cursor:pointer}

    @media(max-width:900px){.sidebar{display:none}.book-wrap{width:92%;height:78%}}
  </style>
</head>
<body>
  <div class="bg"></div>
  <canvas id="stars" class="stars"></canvas>

  <!-- ENTER -->
  <div class="enter-wrap" id="enterWrap">
    <div class="glass" role="dialog">
      <div style="flex:1">
        <h1>Open RealDiary ‚Äî Ultra Realistic</h1>
        <p style="opacity:0.8">Unlimited pages, hyper-real page turns, handwriting brush, paper texture, save PNG & library ‚Äî all stored locally.</p>
      </div>
      <div style="display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center">
        <button class="enter-btn" id="enterBtn">ENTER</button>
        <button class="btn" id="openSample">Open Sample</button>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none;position:relative;z-index:10">
    <div class="topbar">
      <div style="display:flex;align-items:center;gap:12px"><div class="mark">RD</div><div><strong>RealDiary</strong><div style="font-size:12px;opacity:0.7">Priyanshu ‚Ä¢ Ria</div></div></div>
      <div class="top-actions">
        <div class="tools">
          <button class="btn" id="openIndexBtn">üìö Index</button>
          <button class="btn" id="newPageBtn">‚ûï New Page</button>
          <button class="btn" id="undoDrawBtn">‚Ü∫ Undo</button>
          <button class="btn" id="clearDrawBtn">üßº Clear Draw</button>
          <button class="btn" id="downloadAllBtn">‚¨áÔ∏è Export All</button>
        </div>
      </div>
    </div>

    <div class="main">
      <aside class="sidebar">
        <h3>Library</h3>
        <div id="libraryList" class="lib-grid"></div>
      </aside>

      <section class="content">
        <div class="book-wrap">
          <div class="book" id="book">
            <div class="cover" id="cover">
              <div style="font-size:20px;font-weight:800">My RealDiary</div>
              <div style="opacity:0.9;margin-top:8px">Tap to open ‚Äî realistic page-turns & handwriting</div>
              <div class="spine"></div>
            </div>

            <div class="pages" id="pages"></div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- INDEX OVERLAY -->
  <div class="index-overlay" id="indexOverlay">
    <div class="index-panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <h2 style="margin:0">Library</h2>
        <div><button class="btn" id="closeIndex">Close</button></div>
      </div>
      <div id="indexGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px"></div>
    </div>
  </div>

  <a id="downloadAnchor" style="display:none"></a>

  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
  // ---------- Utilities ----------
  const $ = s=>document.querySelector(s);
  const uid = (p='p')=>p+Math.random().toString(36).slice(2,9);

  // ---------- Starfield ----------
  (function(){const c=$('#stars');const ctx=c.getContext('2d');function r(){c.width=innerWidth;c.height=innerHeight}addEventListener('resize',r);r();const stars=[];for(let i=0;i<300;i++)stars.push({x:Math.random()*c.width,y:Math.random()*c.height,r:Math.random()*1.6,alpha:Math.random()});function draw(){ctx.clearRect(0,0,c.width,c.height);for(const s of stars){ctx.globalAlpha=s.alpha;ctx.beginPath();ctx.fillStyle='#fff';ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill()}}setInterval(()=>{for(const s of stars){s.alpha=0.3+Math.random()*0.8;s.x+=Math.random()*1-0.4;if(s.x>c.width)s.x=0;if(s.x<0)s.x=c.width}},700); (function loop(){draw();requestAnimationFrame(loop)})();})();

  // ---------- State & Storage ----------
  const LS_KEY='realdiary_pages_v2';
  const state={pages:[], currentId:null};
  function load(){try{const raw=localStorage.getItem(LS_KEY);state.pages=raw?JSON.parse(raw):[];}catch(e){state.pages=[]}};
  function save(){localStorage.setItem(LS_KEY, JSON.stringify(state.pages)); renderLibrary(); renderIndexGrid();}

  // ---------- Page Model ----------
  function newPage(title='Untitled'){return {id:uid(),title,content:'',drawings:[],created:Date.now()}}

  // ---------- Render Library ----------
  function renderLibrary(){const list=$('#libraryList');list.innerHTML='';if(!state.pages.length){list.innerHTML='<div style="opacity:0.7">No saved pages yet</div>';return}state.pages.slice().reverse().forEach(p=>{const card=document.createElement('div');card.className='card';card.innerHTML=`<div class='thumb' data-id='${p.id}'></div><div style='flex:1'><strong>${escape(p.title)}</strong><div style='font-size:12px;opacity:0.7'>${new Date(p.created).toLocaleString()}</div></div><div style='display:flex;flex-direction:column;gap:6px'><button class='btn' data-open='${p.id}'>Open</button><button class='btn' data-png='${p.id}'>PNG</button></div>`;list.appendChild(card); // draw simple thumb
    const thumb=card.querySelector('.thumb'); thumb.style.background='#f8f5ef'; thumb.title=p.title; thumb.style.display='flex'; thumb.style.alignItems='center'; thumb.style.justifyContent='center'; thumb.style.fontSize='12px'; thumb.textContent=(p.title||'Untitled').slice(0,12);
  })}

  function renderIndexGrid(){const g=$('#indexGrid');g.innerHTML='';state.pages.slice().reverse().forEach(p=>{const el=document.createElement('div');el.style.padding='12px';el.style.borderRadius='8px';el.style.background='linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))';el.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${escape(p.title)}</strong><div style="font-size:12px;opacity:0.7">${new Date(p.created).toLocaleString()}</div></div><div style="display:flex;flex-direction:column;gap:6px"><button class='btn' data-open='${p.id}'>Open</button><button class='btn' data-download='${p.id}'>PNG</button></div></div>`;g.appendChild(el)})}

  // ---------- Pages DOM & Interaction ----------
  const pagesRoot = $('#pages');

  function clearPages(){pagesRoot.innerHTML=''}

  // create visual page with paper, editor and a drawing canvas overlay
  function createPageElement(pageData,stackIndex=0){
    const el=document.createElement('div'); el.className='page'; el.dataset.id=pageData.id; el.style.zIndex=100-stackIndex; el.style.transform = `translateZ(${stackIndex*-6}px)`;
    el.style.left='0'; el.style.top='0';
    // inner paper
    const paper=document.createElement('div'); paper.className='paper'; paper.style.backgroundColor='#fbf8f3';
    // title and editor
    const title=document.createElement('div'); title.className='title'; title.textContent=pageData.title; title.contentEditable=true; title.style.cursor='text'; title.style.userSelect='text'; title.style.marginBottom='8px'; title.style.color='#111';
    const editor=document.createElement('div'); editor.className='editor'; editor.contentEditable=true; editor.spellcheck=false; editor.innerHTML=pageData.content||'';
    // drawing canvas overlay
    const drawCanvas = document.createElement('canvas'); drawCanvas.className='draw-canvas'; drawCanvas.width=800; drawCanvas.height=600; drawCanvas.style.position='absolute'; drawCanvas.style.left='0'; drawCanvas.style.top='0'; drawCanvas.style.pointerEvents='none';

    // controls
    const controls=document.createElement('div'); controls.className='page-controls';
    const saveBtn=document.createElement('button'); saveBtn.className='btn'; saveBtn.textContent='üíæ Save';
    const pngBtn=document.createElement('button'); pngBtn.className='btn'; pngBtn.textContent='üì∑ Save PNG';
    const turnBtn=document.createElement('button'); turnBtn.className='btn'; turnBtn.textContent='‚§µÔ∏è Turn';
    controls.appendChild(saveBtn); controls.appendChild(pngBtn); controls.appendChild(turnBtn);

    paper.appendChild(title); paper.appendChild(editor); paper.appendChild(controls);
    el.appendChild(paper); el.appendChild(drawCanvas);

    // place sizes responsive
    function fitCanvas(){ const r=paper.getBoundingClientRect(); drawCanvas.width = Math.round(r.width); drawCanvas.height=Math.round(r.height); drawCanvas.style.width=r.width+'px'; drawCanvas.style.height=r.height+'px'; drawCanvas.style.left=r.left+'px'; drawCanvas.style.top=r.top+'px'; drawCanvas.style.pointerEvents='none'; }
    // ensure it fits (we'll reposition dynamically when needed)
    setTimeout(()=>{fitCanvas(); window.addEventListener('resize', fitCanvas)},50);

    // Enable page-turn when clicking turnBtn or clicking right edge
    turnBtn.addEventListener('click', (ev)=>{ev.stopPropagation(); performPageTurn(el);});
    el.addEventListener('click',(ev)=>{const r=el.getBoundingClientRect(); const x=ev.clientX - r.left; if(x > r.width*0.78) performPageTurn(el)});

    // Save handler
    saveBtn.addEventListener('click',(ev)=>{ev.stopPropagation(); const content=editor.innerHTML; const titleText=title.textContent||'Untitled'; const idx=state.pages.findIndex(p=>p.id===pageData.id); if(idx>=0){state.pages[idx].content=content;state.pages[idx].title=titleText; // gather drawing as data URL
      state.pages[idx].drawings = captureDrawings(el); save(); alert('Saved.'); } else {state.pages.push({id:pageData.id,title:titleText,content:content,drawings:captureDrawings(el),created:Date.now()}); save(); alert('Saved to Library.');}
    });

    // PNG handler
    pngBtn.addEventListener('click',(ev)=>{ev.stopPropagation(); exportPagePNG(el, pageData.title||'page')});

    // restore drawings onto canvas
    setTimeout(()=>{restoreDrawingsToCanvas(el, pageData.drawings||[])},120);

    return el;
  }

  // render top N pages (unlimited support via state array)
  function renderPages(){ clearPages(); // show last up to 12 pages stacked
    const last = state.pages.slice(-12);
    if(!last.length){ const temp=newPage('Blank'); temp.id='temp'; const el=createPageElement(temp,0); pagesRoot.appendChild(el); state.currentId=temp.id; return }
    last.forEach((p,i)=>{ const el=createPageElement(p, i); pagesRoot.appendChild(el) })
  }

  // Page-turn animation: rotateY with curl shadow emulation
  function performPageTurn(pageEl){ pageEl.style.transition='transform 1000ms cubic-bezier(.2,.8,.2,1), box-shadow 1000ms'; pageEl.style.transform='rotateY(-170deg) translateX(-40px)'; pageEl.style.boxShadow='0 80px 160px rgba(2,6,10,0.9)'; setTimeout(()=>{ // remove turned page from DOM and also from state if it's a temp unsaved page
      const id=pageEl.dataset.id; pageEl.remove(); // if page exists in state, move it earlier in array (simulate flipping forward) ‚Äî we won't delete
      // Append a fresh blank page to the end to simulate infinite pages
      const p=newPage('Page '+(state.pages.length+1)); state.pages.push(p); save(); renderPages(); },980);
  }

  // ---------- Drawing (handwriting) ----------
  let drawState = {enabled:false,ctxs: new Map(), strokes: new Map(), undoStacks: new Map(), current:{color:'#111', size:3}};

  // We'll use pointer events on a top invisible layer to capture drawing then map to canvas inside page
  function enableDrawingOnPage(pageEl){ const canvas = pageEl.querySelector('.draw-canvas'); if(!canvas) return; canvas.style.pointerEvents='auto'; const ctx = canvas.getContext('2d'); ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle = drawState.current.color; ctx.lineWidth = drawState.current.size; drawState.ctxs.set(pageEl.dataset.id, ctx); drawState.strokes.set(pageEl.dataset.id, []); drawState.undoStacks.set(pageEl.dataset.id, []);
    let drawing=false; let last=null; function getXY(e){ const rect=canvas.getBoundingClientRect(); return {x: (e.clientX-rect.left)*(canvas.width/rect.width), y:(e.clientY-rect.top)*(canvas.height/rect.height)} }
    function down(e){ e.preventDefault(); drawing=true; last=getXY(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); }
    function move(e){ if(!drawing) return; const p=getXY(e); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; }
    function up(e){ if(!drawing) return; drawing=false; // store image snapshot into strokes for undo
      drawState.undoStacks.get(pageEl.dataset.id).push(canvas.toDataURL()); }
    // Pointer events
    canvas.addEventListener('pointerdown', down); window.addEventListener('pointermove', move); window.addEventListener('pointerup', up);
    // store ctx
    drawState.ctxs.set(pageEl.dataset.id, ctx);
  }

  // Restore drawings array (dataURLs) to canvas inside page
  function restoreDrawingsToCanvas(pageEl, drawings){ const canvas = pageEl.querySelector('.draw-canvas'); if(!canvas) return; const ctx=canvas.getContext('2d'); canvas.width = Math.round(pageEl.querySelector('.paper').clientWidth); canvas.height = Math.round(pageEl.querySelector('.paper').clientHeight); ctx.clearRect(0,0,canvas.width,canvas.height); drawings.forEach(d=>{ const img=new Image(); img.onload=()=>{ ctx.drawImage(img,0,0,canvas.width,canvas.height) }; img.src=d }); // enable drawing after restore
    enableDrawingOnPage(pageEl);
  }

  // Capture drawings: snapshot canvas to dataURL; for now capture single canvas per page
  function captureDrawings(pageEl){ const canvas = pageEl.querySelector('.draw-canvas'); if(!canvas) return []; try{ return [canvas.toDataURL()]; }catch(e){return []} }

  // Undo and clear functions
  function undoDrawOnVisible(){ const top = pagesRoot.lastElementChild; if(!top) return; const canvas=top.querySelector('.draw-canvas'); if(!canvas) return; const stack = drawState.undoStacks.get(top.dataset.id)||[]; if(stack.length>1){ stack.pop(); const prev = stack[stack.length-1]; const img=new Image(); img.onload=()=>{ const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,canvas.width,canvas.height) }; img.src=prev } else { const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height); drawState.undoStacks.set(top.dataset.id,[]) } }
  function clearDrawOnVisible(){ const top = pagesRoot.lastElementChild; if(!top) return; const canvas=top.querySelector('.draw-canvas'); if(!canvas) return; const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height); drawState.undoStacks.set(top.dataset.id,[]) }

  // ---------- Exporting ----------
  function exportPagePNG(pageEl, title='page'){ // we will render paper area into canvas using html2canvas then merge drawing canvas
    const paper = pageEl.querySelector('.paper'); html2canvas(paper, {scale:2, backgroundColor:'#fff'}).then(baseCanvas=>{
      const draw = pageEl.querySelector('.draw-canvas'); const tmp = document.createElement('canvas'); tmp.width = baseCanvas.width; tmp.height=baseCanvas.height; const tctx = tmp.getContext('2d'); tctx.drawImage(baseCanvas,0,0);
      if(draw){ // draw drawings scaled
        const dimg = new Image(); dimg.onload = ()=>{ tctx.drawImage(dimg,0,0,tmp.width,tmp.height); tmp.toBlob(blob=>{ const url=URL.createObjectURL(blob); const a=$('#downloadAnchor'); a.href=url; a.download=(title.replace(/[^a-z0-9]/gi,'_')||'page')+'.png'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),2000); }); }; dimg.src = draw.toDataURL(); } else { tmp.toBlob(blob=>{ const url=URL.createObjectURL(blob); const a=$('#downloadAnchor'); a.href=url; a.download=(title.replace(/[^a-z0-9]/gi,'_')||'page')+'.png'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),2000); }); }
    }).catch(e=>{console.error(e); alert('Export failed: '+e.message)})
  }

  function downloadPagePNGFromData(pageData){ const tmp = document.createElement('div'); tmp.style.width='800px'; tmp.style.height='600px'; tmp.style.padding='24px'; tmp.style.background='#fff'; tmp.style.color='#111'; tmp.innerHTML=`<h2>${escape(pageData.title)}</h2><div>${pageData.content}</div>`; document.body.appendChild(tmp); html2canvas(tmp, {scale:2}).then(c=>{ c.toBlob(blob=>{ const url=URL.createObjectURL(blob); const a=$('#downloadAnchor'); a.href=url; a.download=(pageData.title.replace(/[^a-z0-9]/gi,'_')||'page')+'.png'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),2000); tmp.remove(); })}).catch(e=>{tmp.remove();alert('Export error')}) }

  // ---------- Helpers ----------
  function escape(s){ return String(s||'').replace(/[&<>\"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'})[c]) }

  // ---------- UI Actions ----------
  $('#enterBtn').addEventListener('click', ()=>{ $('#enterWrap').style.display='none'; $('#app').style.display='block'; load(); renderLibrary(); renderPages(); });
  $('#openSample').addEventListener('click', ()=>{ // load a sample set
    load(); if(state.pages.length===0){ state.pages.push({id:uid(),title:'Memories',content:'<p>This is your first saved page. Write here.</p>',drawings:[],created:Date.now()}); state.pages.push({id:uid(),title:'Dreams',content:'<p>Second page.</p>',drawings:[],created:Date.now()}); save(); } $('#enterWrap').style.display='none'; $('#app').style.display='block'; renderLibrary(); renderPages(); });

  $('#newPageBtn').addEventListener('click', ()=>{ const p=newPage('Page '+(state.pages.length+1)); state.pages.push(p); save(); renderPages(); });
  $('#downloadAllBtn').addEventListener('click', ()=>{ const data=JSON.stringify(state.pages,null,2); const blob=new Blob([data],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=$('#downloadAnchor'); a.href=url; a.download='realdiary-backup.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),2000); });
  $('#openIndexBtn').addEventListener('click', ()=>{ renderIndexGrid(); $('#indexOverlay').style.display='flex'; });
  $('#closeIndex').addEventListener('click', ()=>{ $('#indexOverlay').style.display='none' });

  // Index actions
  $('#indexOverlay').addEventListener('click',(e)=>{ const openId = e.target.closest('[data-open]')?.dataset.open; const downloadId = e.target.closest('[data-download]')?.dataset.download; if(openId){ openSaved(openId); $('#indexOverlay').style.display='none' } if(downloadId){ const p=state.pages.find(x=>x.id===downloadId); if(p) downloadPagePNGFromData(p) } });

  // library sidebar actions
  $('#libraryList').addEventListener('click',(e)=>{ const id=e.target.closest('[data-open]')?.dataset.open; const png=e.target.closest('[data-png]')?.dataset.png; if(id) openSaved(id); if(png){ const p=state.pages.find(x=>x.id===png); if(p) downloadPagePNGFromData(p) } });

  function openSaved(id){ const p=state.pages.find(x=>x.id===id); if(!p) return alert('Not found'); clearPages(); const el=createPageElement(p,0); pagesRoot.appendChild(el); }

  // Undo & clear draw buttons
  $('#undoDrawBtn').addEventListener('click', ()=>{ undoDrawOnVisible(); });
  $('#clearDrawBtn').addEventListener('click', ()=>{ clearDrawOnVisible(); });

  // global keyboard shortcuts: Ctrl+S save visible
  window.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='s'){ e.preventDefault(); // save top visible
      const top=pagesRoot.lastElementChild; if(!top) return; const title=top.querySelector('.title').textContent||'Untitled'; const content=top.querySelector('.editor').innerHTML; const idx=state.pages.findIndex(p=>p.id===top.dataset.id); if(idx>=0){ state.pages[idx].title=title; state.pages[idx].content=content; state.pages[idx].drawings=captureDrawings(top); save(); alert('Saved'); } else { state.pages.push({id:top.dataset.id,title,content,drawings:captureDrawings(top),created:Date.now()}); save(); alert('Saved to Library.'); } }
  });

  // save before unload
  window.addEventListener('beforeunload', ()=>{ save(); });

  // initial load (show enter overlay)
  (function init(){ load(); renderLibrary(); renderIndexGrid(); })();

  // make sure drawing canvases become interactive when pages are rendered (polling approach)
  const mo = new MutationObserver(()=>{ // after pages rendered, attach drawing to each
    const pageEls = pagesRoot.querySelectorAll('.page'); pageEls.forEach(pe=>{ if(!drawState.ctxs.has(pe.dataset.id)) restoreDrawingsToCanvas(pe, (state.pages.find(x=>x.id===pe.dataset.id)||{}).drawings||[]) })
  }); mo.observe(pagesRoot,{childList:true,subtree:true});

  </script>
</body>
</html>
